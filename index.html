<!doctype html> <html lang=en  class=has-navbar-fixed-top > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link rel=stylesheet  href="/css/styles.css"> <style> html {font-size: 17px;} .franklin-content {position: relative; padding-left: 8%; padding-right: 5%; line-height: 1.35em;} @media (min-width: 940px) { .franklin-content {width: 100%; margin-left: auto; margin-right: auto;} } @media (max-width: 768px) { .franklin-content {padding-left: 6%; padding-right: 6%;} } </style> <link rel=icon  href="/assets/favicon.png"> <title>Template</title> <script src="/libs/highlight/highlight.pack.js"></script> <script src="https://unpkg.com/clipboard@2/dist/clipboard.min.js"></script> <script type=module  src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script> <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script> <script> hljs.getLanguage('julia').keywords.custom = 'obj grad hess AbstractNLPModel'; </script> <nav class="navbar is-primary is-fixed-top" role=navigation  aria-label="main navigation"> <div class=navbar-brand > <a class=navbar-item  href="https://jso-docs.github.io"> <img src="/assets/jso.png"> </a> <a role=button  class=navbar-burger  aria-label=menu  aria-expanded=false  data-target=navbarBasicExample > <span aria-hidden=true ></span> <span aria-hidden=true ></span> <span aria-hidden=true ></span> </a> </div> <div id=navbarBasicExample  class=navbar-menu > <div class=navbar-start > <a class=navbar-item  href="/"> Home </a> <a class=navbar-item  href="/tutorials"> Tutorials </a> <div class="navbar-item has-dropdown is-hoverable"> <a class=navbar-link  href="/ecosystems/index.html"> Ecosystems </a> <div class=navbar-dropdown > <a class=navbar-item  href="/ecosystems/linear-algebra"> Linear Algebra </a> <a class=navbar-item  href="/ecosystems/models"> Models </a> <a class=navbar-item  href="/ecosystems/solvers"> Solvers </a> </div> </div> <a class=navbar-item  href="/references"> References </a> <a class=navbar-item  href="/contributing"> Contributing </a> </div> <div class=navbar-end > <div class=navbar-item > </div> </div> </div> </nav> <section class=section > <div class=container > <div class=content ><div class=franklin-content ><h1 id=title ><a href="#title" class=header-anchor >Template</a></h1></p> <div class=author >by AUTHORS</div> <p><img class=badge  src="https://img.shields.io/badge/DCISolver-0.2.5-hsl(83,100%25,30%25)?style=flat-square&labelColor=hsl(83,30%25,30%25)"> <img class=badge  src="https://img.shields.io/badge/Gridap-0.15.5-666?style=flat-square&labelColor=999"> <img class=badge  src="https://img.shields.io/badge/JSOSolvers-0.7.4-hsl(110,100%25,30%25)?style=flat-square&labelColor=hsl(110,30%25,30%25)"> <img class=badge  src="https://img.shields.io/badge/Logging-nothing-666?style=flat-square&labelColor=999"> <img class=badge  src="https://img.shields.io/badge/NLPModelsIpopt-0.8.0-hsl(221,100%25,30%25)?style=flat-square&labelColor=hsl(221,30%25,30%25)"> <img class=badge  src="https://img.shields.io/badge/NLPModelsModifiers-0.5.1-666?style=flat-square&labelColor=999"> <img class=badge  src="https://img.shields.io/badge/PDENLPModels-0.3.0-666?style=flat-square&labelColor=999"> <h1 id=solve_large-scale_problem_with_dcisolver ><a href="#solve_large-scale_problem_with_dcisolver" class=header-anchor >Solve Large-Scale Problem with DCISolver</a></h1> <p>In this tutorial we use <code>dci</code> to solve a large-scale optimization problem resulting from the discretization of a PDE-constrained optimization problem and compare the solve with Ipopt.</p> <h2 id=problem_statement ><a href="#problem_statement" class=header-anchor >Problem Statement</a></h2> <p>Let Ω &#61; &#40;-1,1&#41;², we solve the following distributed Poisson control problem with Dirichlet boundary:</p> <pre><code class=language-math >\left\lbrace
   \begin&#123;aligned&#125;
      \min_&#123;y \in H^1_0, u \in H^1&#125; \quad &amp;  \frac&#123;1&#125;&#123;2&#125; \int_\Omega |y&#40;x&#41; - y_d&#40;x&#41;|^2dx &#43; \frac&#123;\alpha&#125;&#123;2&#125; \int_\Omega |u|^2dx \\
      \text&#123;s.t.&#125; &amp; -\Delta y &#61; h &#43; u, \quad x \in \Omega, \\
                  &amp; y &#61; 0, \quad x \in \partial \Omega,
   \end&#123;aligned&#125;
   \right.</code></pre> <p>where yd&#40;x&#41; &#61; -x₁² and α &#61; 1e-2. The force term is h&#40;x₁, x₂&#41; &#61; - sin&#40;ω x₁&#41;sin&#40;ω x₂&#41; with ω &#61; π - 1/8.</p> <p>We refer to <a href="https://github.com/gridap/Gridap.jl">Gridap.jl</a> for more details on modeling PDEs and <a href="https://github.com/JuliaSmoothOptimizers/PDENLPModels.jl">PDENLPModels.jl</a> for PDE-constrained optimization problems.</p> <pre><code class=language-julia >using Gridap, PDENLPModels</code></pre>
<p>Definition of the domain and discretization</p>
<pre><code class=language-julia >n &#61; 20
domain &#61; &#40;-1, 1, -1, 1&#41;
partition &#61; &#40;n, n&#41;
model &#61; CartesianDiscreteModel&#40;domain, partition&#41;</code></pre><pre><code class="plaintext code-output">CartesianDiscreteModel()</code></pre>
<p>Definition of the FE-spaces</p>
<pre><code class=language-julia >reffe &#61; ReferenceFE&#40;lagrangian, Float64, 2&#41;
Xpde &#61; TestFESpace&#40;model, reffe; conformity &#61; :H1, dirichlet_tags &#61; &quot;boundary&quot;&#41;
y0&#40;x&#41; &#61; 0.0
Ypde &#61; TrialFESpace&#40;Xpde, y0&#41;

reffe_con &#61; ReferenceFE&#40;lagrangian, Float64, 1&#41;
Xcon &#61; TestFESpace&#40;model, reffe_con; conformity &#61; :H1&#41;
Ycon &#61; TrialFESpace&#40;Xcon&#41;
Y &#61; MultiFieldFESpace&#40;&#91;Ypde, Ycon&#93;&#41;</code></pre><pre><code class="plaintext code-output">MultiFieldFESpace()</code></pre>
<p>Integration machinery</p>
<pre><code class=language-julia >trian &#61; Triangulation&#40;model&#41;
degree &#61; 1
dΩ &#61; Measure&#40;trian, degree&#41;</code></pre><pre><code class="plaintext code-output">Measure()</code></pre>
<p>Objective function</p>
<pre><code class=language-julia >yd&#40;x&#41; &#61; -x&#91;1&#93;^2
α &#61; 1e-2
function f&#40;y, u&#41;
  ∫&#40;0.5 * &#40;yd - y&#41; * &#40;yd - y&#41; &#43; 0.5 * α * u * u&#41; * dΩ
end</code></pre><pre><code class="plaintext code-output">f (generic function with 1 method)</code></pre>
<p>Definition of the constraint operator</p>
<pre><code class=language-julia >ω &#61; π - 1 / 8
h&#40;x&#41; &#61; -sin&#40;ω * x&#91;1&#93;&#41; * sin&#40;ω * x&#91;2&#93;&#41;
function res&#40;y, u, v&#41;
  ∫&#40;∇&#40;v&#41; ⊙ ∇&#40;y&#41; - v * u - v * h&#41; * dΩ
end
op &#61; FEOperator&#40;res, Y, Xpde&#41;</code></pre><pre><code class="plaintext code-output">FEOperatorFromWeakForm()</code></pre>
<p>Definition of the initial guess</p>
<pre><code class=language-julia >npde &#61; Gridap.FESpaces.num_free_dofs&#40;Ypde&#41;
ncon &#61; Gridap.FESpaces.num_free_dofs&#40;Ycon&#41;
x0 &#61; zeros&#40;npde &#43; ncon&#41;;</code></pre>
<p>Overall, we built a GridapPDENLPModel, which implements the <a href="https://github.com/JuliaSmoothOptimizers/NLPModels.jl">NLPModels.jl</a> API.</p>
<pre><code class=language-julia >nlp &#61; GridapPDENLPModel&#40;x0, f, trian, Ypde, Ycon, Xpde, Xcon, op, name &#61; &quot;Control elastic membrane&quot;&#41;

&#40;nlp.meta.nvar, nlp.meta.ncon&#41;</code></pre><pre><code class="plaintext code-output">(1962, 1521)</code></pre>
<h2 id=find_a_feasible_point ><a href="#find_a_feasible_point" class=header-anchor >Find a Feasible Point</a></h2>
<p>Before solving the previously defined model, we will first improve our initial guess. We use <code>FeasibilityResidual</code> from <a href="https://github.com/JuliaSmoothOptimizers/NLPModelsModifiers.jl">NLPModelsModifiers.jl</a> to convert the NLPModel as an NLSModel. Then, using <code>trunk</code>, a solver for least-squares problems implemented in <a href="https://github.com/JuliaSmoothOptimizers/JSOSolvers.jl">JSOSolvers.jl</a>, we find An improved guess which is close to being feasible for our large-scale problem. By default, a JSO-compliant solver such as <code>trunk</code> &#40;the same applies to <code>dci</code>&#41; uses by default <code>nlp.meta.x0</code> as an initial guess.</p>
<pre><code class=language-julia >using JSOSolvers, NLPModelsModifiers

nls &#61; FeasibilityResidual&#40;nlp&#41;
stats_trunk &#61; trunk&#40;nls&#41;</code></pre><pre><code class="plaintext code-output">"Execution stats: first-order stationary"</code></pre>
<p>We check the solution from the stats returned by <code>trunk</code>:</p>
<pre><code class=language-julia >norm&#40;cons&#40;nlp, stats_trunk.solution&#41;&#41;</code></pre><pre><code class="plaintext code-output">1.6058259477686155e-5</code></pre>
<p>We will use the solution found to initialize our solvers.</p>
<h2 id=solve_the_problem ><a href="#solve_the_problem" class=header-anchor >Solve the Problem</a></h2>
<p>Finally, we are ready to solve the PDE-constrained optimization problem with a targeted tolerance of <code>1e-5</code>. In the following, we will use both Ipopt and DCI on our problem.</p>
<pre><code class=language-julia >using NLPModelsIpopt

stats_ipopt &#61; ipopt&#40;nlp, x0 &#61; stats_trunk.solution, tol &#61; 1e-5, print_level &#61; 0&#41;</code></pre><pre><code class="plaintext code-output">
******************************************************************************
This program contains Ipopt, a library for large-scale nonlinear optimization.
 Ipopt is released as open source code under the Eclipse Public License (EPL).
         For more information visit https://github.com/coin-or/Ipopt
******************************************************************************

"Execution stats: first-order stationary"</code></pre>
<p>The problem was successfully solved, and we can extract the function evaluations from the stats.</p>
<pre><code class=language-julia >stats_ipopt.counters</code></pre><pre><code class="plaintext code-output">  Counters:
             obj: ██████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 9                 grad: ███████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 10                cons: ████████████⋅⋅⋅⋅⋅⋅⋅⋅ 18    
            jcon: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jgrad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                  jac: ███████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 10    
           jprod: ███████████████⋅⋅⋅⋅⋅ 22              jtprod: ████████████████████ 30                hess: ██████⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 8     
           hprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jhess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jhprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
        residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0         jac_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0       jprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
 jtprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0        hess_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0       jhess_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
  hprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
</code></pre>
<p>Reinitialize the counters before re-solving.</p>
<pre><code class=language-julia >reset&#33;&#40;nlp&#41;;</code></pre>
<p><code>NullLogger</code> avoids printing iteration information.</p>
<pre><code class=language-julia >using DCISolver, Logging

stats_dci &#61; with_logger&#40;NullLogger&#40;&#41;&#41; do
  dci&#40;nlp, stats_trunk.solution, atol &#61; 1e-5, rtol &#61; 0.0&#41;
end</code></pre><pre><code class="plaintext code-output">"Execution stats: first-order stationary"</code></pre>
<p>The problem was successfully solved, and we can extract the function evaluations from the stats.</p>
<pre><code class=language-julia >stats_dci.counters</code></pre><pre><code class="plaintext code-output">  Counters:
             obj: █⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4                 grad: █⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4                 cons: █⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 4     
            jcon: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jgrad: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                  jac: █⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 2     
           jprod: ████████████████████ 137             jtprod: ████████████████████ 137               hess: █⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 2     
           hprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0                jhess: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0               jhprod: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
        residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0         jac_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0       jprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
 jtprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0        hess_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0       jhess_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
  hprod_residual: ⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅⋅ 0     
</code></pre>
<p>We now compare the two solvers with respect to the time spent,</p>
<pre><code class=language-julia >stats_ipopt.elapsed_time, stats_dci.elapsed_time</code></pre><pre><code class="plaintext code-output">(37.611, 22.04666805267334)</code></pre>
<p>and also check objective value, feasibility and dual feasibility of <code>ipopt</code> and <code>dci</code>.</p>
<pre><code class=language-julia >&#40;stats_ipopt.objective, stats_ipopt.primal_feas, stats_ipopt.dual_feas&#41;,
&#40;stats_dci.objective, stats_dci.primal_feas, stats_dci.dual_feas&#41;</code></pre><pre><code class="plaintext code-output">((0.005425026428348349, 2.2204460492503135e-18, 4.2724309076258577e-7), (0.005425025540071085, 1.346393348470671e-11, 9.5872029648046e-7))</code></pre>
<p>Overall <code>DCISolver</code> is doing great for solving large-scale optimization problems&#33;</p>

</div>
    </div>  
    </div>  
    </div>  
  </section>  

    
    
        
<script>hljs.initHighlightingOnLoad(); hljs.configure({ tabReplace: '    ' });</script>


<script>
  (function () {

    // Get the elements.
    // - the 'pre' element.
    // - the 'div' with the 'paste-content' id.

    var pre = document.getElementsByTagName('pre');

    // Add a copy button in the 'pre' element with className language-julia

    for (var i = 0; i < pre.length; i++) {
      var isLanguage = pre[i].children[0].className.indexOf('language-julia');

      if (isLanguage === 0) {
        var ion_icon = document.createElement('ion-icon');
        ion_icon.name = 'copy';

        var icon = document.createElement('span');
        icon.className = 'icon has-text-primary';
        icon.appendChild(ion_icon);

        var button = document.createElement('button');
        button.className = 'button copy-button is-light is-primary';
        button.appendChild(icon);

        pre[i].appendChild(button);
      }
    };

    // Run Clipboard

    var copyCode = new ClipboardJS('.copy-button', {
      target: function (trigger) {
        return trigger.previousElementSibling;
      }
    });

    copyCode.on('success', function (event) {
      event.clearSelection();
      var btn = event.trigger;
      var old_button_class = btn.className;
      var old_icon_class = btn.children[0].className;
      btn.className = 'button copy-button is-primary';
      btn.children[0].className = 'icon has-text-white';
      window.setTimeout(function () {
        event.trigger.className = old_button_class;
        event.trigger.children[0].className = old_icon_class;
      }, 1000);

    });

  })();
</script>
    
    <footer class=footer >
      <div class="content has-text-centered is-small">
        &copy; Abel Soares Siqueira. <br>
        Last modified: January 20, 2022.<br>
        <a ckass=link  href="https://github.com/jso-docs/">jso-docs at GitHub</a>
      </div>
    </footer>